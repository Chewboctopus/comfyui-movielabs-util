# MovieLabs ComfyUI Nodes for Provenance Capture

## Introduction

This document introduces an early release of custom ComfyUI nodes designed for provenance tracking. The nodes are integrated with ShotGrid. An appropriately configured ShotGrid instance is necessary for using these custom nodes. See Appendix B: ShotGrid Integration below for details.

Three nodes have been developed: **Provenance Connector**, **Asset Provenance**, and **Save Image with Provenance**. When properly configured, these nodes embed provenance metadata into the generated images, plus those images and metadata will be uploaded to ShotGrid as Versions of a selected Shot and Task, if the user sets the `for_review` flag to `True` in the Asset Provenance node.

We encourage you to experiment with these nodes and provide feedback.

## Installation and Setup

1. Unzip the provided directory and place it inside `ComfyUI/custom_nodes/`. Alternatively, git clone https://github.com/MovieLabs/comfyui-movielabs-util into `ComfyUI/custom_nodes/`.
2. Create workflows in ComfyUI using the three custom nodes. Refer to [Appendix A](#appendix-a-using-the-custom-nodes) for details on their usage.
3. Generate images, and inspect the embedded metadata using `exiftool`:

   - For **PNG files**, metadata will include the tags:
     - `prompt`, `workflow` (generated by standard nodes)
     - `provenance`, `saveImageNodeId`, `provenanceNodeId`, `batchId` (added by custom nodes)

4. Additional provenance-related metadata is embedded, which is used.
5. The images and videos should be uploaded to ShotGrid as Versions of a selected Shot and Task, if the user sets the `for_review` flag to `True` in the Asset Provenance node.

---

## Appendix A: Using the Custom Nodes

### 1. Preconfigured Workflows

A sample workflow is provided under `example_workflows/` for image generation.

### 2. Asset Provenance Node

- This node can be located in the ComfyUI interface by searching for **"Asset Provenance"** under:  
  **MovieLabs > Util > Grant8&9**

#### **Functionality**
- This node is used to capture provenance metadata.
- Multiple instances of this nodecan be added within a workflow, but it is recommended to **reuse the same node** if the same provenance data applies to multiple outputs.
- Use a **different node** to apply different provenance data to other outputs.

#### **The node includes fields for:**
- `shot_code`, `task_name`, `notes` (uses identifiers internally, with names for dropdown selection)
- `for_review` (boolean flag to indicate if the asset is a candidate for review)

---

### 3. Provenance Connector Node

- This node can be found in ComfyUI by searching for **"Provenance Connector"**.

#### **Functionality**
- Connects **Asset Provenance** metadata with image outputs.
- Requires **two inputs**:
  1. One from an **Asset Provenance** node.
  2. One from an **image-generating workflow** node.

#### **Best Practices**
- Use **one Provenance Connector per output node** rather than reusing the same one.
- An **Asset Provenance** node may be reused across multiple **Provenance Connectors** if the metadata applies to multiple outputs.

---

### 4. Save Image with Provenance Node

- This node can be found in ComfyUI by searching for **"Save Image with Provenance"**.

#### **Functionality**
- Saves the input images to your ComfyUI output directory.
- If the `for_review` flag is set to `True` in the Asset Provenance node, the images and metadata will be uploaded to ShotGrid as Versions of a selected Shot and Task. Note if a batch of images are generated, each of the images will be uploaded as a separate Version.


### 5. Metadata Verification

- Once the workflow is queued, use **exiftool** to verify that images/videos contain the expected embedded metadata.
- If the `for_review` flag is set to `True` in the Asset Provenance node, verify that the images and metadata are uploaded to ShotGrid as Versions of a selected Shot and Task.

---

## Appendix B: ShotGrid Integration

### **ShotGrid Configuration within ComfyUI**
- The ShotGrid instance is configured in `shotgrid_config.json`. This file is to be placed in the root directory of the project, i.e., `ComfyUI/custom_nodes/comfyui-movielabs-util/` directory. 
- The `project_id` field is used to select the ShotGrid project.
- The `server_url` field is used to specify the ShotGrid server URL.
- The `client_id` and `client_secret` fields are used to authenticate with ShotGrid. These credentials have to be for a `Script` user belonging to `API Admin` permission group.
- The `comfyui_task_names` field is used to list the ComfyUI related task names to be used in the dropdown.
- The `version_convention` field is used to generate the version code for the uploaded images.
- The `user_login_map` field is used to map the system username to a ShotGrid user email address.

### **ShotGrid Administration**

- Shots must be pre-created in ShotGrid. The `shot_code` field in the Asset Provenance node is used to select the Shot.
- Tasks must be pre-created in ShotGrid for each relevant shot. The name or names of task relevant for ComfyUI work must be added to the `comfyui_task_names` field in the ShotGrid configuration. Assuming only one task is relevant for ComfyUI work and that task name is `Generate Image`, the `comfyui_task_names` field in the ShotGrid configuration should be set to `["Generate Image"]`.
- Custom version fields must be created in ShotGrid. These fields are used to store the provenance metadata. From the Manage Version Fields menu on ShotGrid, create the following fields:
  - Tool: This field is used to store the tool name, which is always `ComfyUI`.
  - ComfyUI Prompt: This field is used to store the prompt.
  - ComfyUI Workflow: This field is used to store the ComfyUI workflow.
  - Extra Metadata: This field is used to store some extra metadata.
  - Notes: This field is used to store the notes.
  - Output: This field is used to store the output.


