# MovieLabs ComfyUI Nodes for Provenance Capture

## Introduction

This document introduces an early release of custom ComfyUI nodes designed for provenance tracking.

Two nodes have been developed: **Provenance Connector** and **Asset Provenance**. These nodes integrate seamlessly with the **Save Image** and **Video Combine** nodes, as well as any other ComfyUI nodes that process images as input. When properly configured, these nodes embed provenance metadata into the generated images and videos.

We encourage you to experiment with these nodes and provide feedback.

## Installation and Setup

1. Unzip the provided directory and place it inside `ComfyUI/custom_nodes/`.
2. Create workflows in ComfyUI using the two custom nodes. Refer to [Appendix A](#appendix-a-using-the-custom-nodes) for details on their usage.
3. Generate images and videos, and inspect the embedded metadata using `exiftool`:

   - For **PNG files**, metadata will include the tags:
     - `Prompt`, `Workflow` (generated by standard nodes)
     - `Provenance`, `Provenance Connector Node Id` (added by custom nodes)
   - For **MP4 files**, metadata is stored under a single `Comment` tag in a JSON format.

4. Additional provenance-related metadata is embedded, which is used.
5. Provide us with generated images and videos (at least two of each type) for review.
6. Think about the questions outlined in [Appendix B](#appendix-b-requested-feedback-and-considerations).

---

## Appendix A: Using the Custom Nodes

### 1. Preconfigured Workflows

Two sample workflows are provided:

- One for **image generation**
- One for **video generation**

These can serve as templates for integration into your own processes.

### 2. Asset Provenance Node

- This node can be located in the ComfyUI interface by searching for **"Asset Provenance"** under:  
  **MovieLabs > Util > Grant8&9**

#### **Functionality**
- This node is used to capture provenance metadata.
- Multiple instances can be added within a workflow, but it is recommended to **reuse the same node** if the same provenance data applies to multiple outputs.
- Use a **different node** to apply different provenance data to other outputs.

#### **The node includes fields for:**
- `shot_name`, `task_name`, `artist_name` (uses identifiers internally, with names for dropdown selection)
- `creative_work`, `script_name` (actually script revision), `asset_type`, `context`

#### **Context Field: Accepts values `"concept"` or `"production"`**
- **Concept:** Used for assets intended for concept development (e.g., character images for LoRA training).
- **Production:** Used for assets generated for production use (e.g., video footage for a final timeline).

  - If `concept` is selected, only character images for LoRA training are expected to be generated (or props if added).
  - If `production` is selected, the **scene number** for which the asset is being generated is expected.

#### **Asset Type Selection**
- The available list follows the **MovieLabs ontology**.
- The dropdown can be customized to limit selections to relevant asset types, **reducing cognitive load** for artists.

---

### 3. Provenance Connector Node

- This node can be found in ComfyUI by searching for **"Provenance Connector"**.

#### **Functionality**
- Connects **Asset Provenance** metadata with image or video outputs.
- Requires **two inputs**:
  1. One from an **Asset Provenance** node.
  2. One from an **image-generating workflow**.

#### **Recommended Structure**

<pre>

(Rest of Workflow) --images--> Provenance Connector --> Save Image / Video Combine 
                                    ^ 
                                    | 
                                    |
                            Asset Provenance

</pre>

#### **Best Practices**
- Use **one Provenance Connector per output node** rather than reusing the same one.
- An **Asset Provenance** node may be reused across multiple **Provenance Connectors** if the metadata applies to multiple outputs.

---

### 4. Metadata Verification

- Once the workflow is queued, use **exiftool** to verify that images/videos contain the expected embedded metadata.

---

## Appendix B: Requested Feedback and Considerations

### **General Feasibility**
- Is this approach workable for your needs?
- Could your existing **ComfyUI workflows** be modified to integrate these nodes (or a future iteration)?

### **ShotGrid Integration**
- How do you define shots within **ShotGrid**?
- Are shots created only for video generation for production material?
- Do you also have shots for character images used in **LoRA training**?
- How are **tasks assigned** to shots?
- How do tasks correlate with **takes** in traditional filmmaking?
- Where should **artist names and IDs** be stored and retrieved?

### **Concept vs. Production Workflow**
- How do you differentiate between **concept development** and **production work**?
- What does it mean to **repeat a workflow**, particularly for production work?
- Does repeating a workflow align with **“takes”** in traditional filmmaking?

We look forward to discussing these points further.
